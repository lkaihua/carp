{{ define "preview_modal" }}

<!-- Modal -->
<div class="modal" id="PreviewModal" tabindex="-1" aria-labelledby="PreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-max-lines-2 text-secondary" id="PreviewModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body flex-center">
        
        <div class="preview-content-container image-container hidden flex-center">
          <img src="" id="ModalPreviewImage"  class="image-grid-transparent-bg"/>
        </div>

        <div class="preview-content-container video-container hidden flex-center">
          <video width="100%" poster="" id="ModalPreviewVideo" preload="metadata" controls autoplay loop playsinline>
            <source src="" type="">
            <p>
              To view this video please enable JavaScript, and consider upgrading to a 
              web browser that supports HTML5 video
            </p>
          </video>
        </div>

      </div>
      <div class="modal-footer">
        <div class="button-container">
          <button class="carousel-control-prev btn" type="button" data-bs-dismiss="modal" id="ModalButtonPrev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>

          <button class="carousel-control-next btn" type="button" data-bs-dismiss="modal" id="ModalButtonNext">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>

          <button type="button" class="btn btn-secondary text-dark" data-bs-dismiss="modal" id="ModalButtonClosePreview">OK</button>
          {{/* <button type="button" class="btn btn-outline-secondary " id="ModalButtonPlay">...</button> */}}
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const previewModal = document.querySelector('#PreviewModal')
const previewTriggerButtons = Array.from(document.querySelectorAll('.btn-preview'))

previewModal.addEventListener('hide.bs.modal', function (event) {
  previewModal.querySelectorAll('.preview-content-container').forEach(c => c.classList.add('hidden'));
  document.querySelector('#ModalPreviewVideo').pause()
  document.querySelector('#ModalPreviewImage').setAttribute('src', '')
})
previewModal.addEventListener('show.bs.modal', function (event) {
  // Button that triggered the modal
  const button = event.relatedTarget
  // Extract info from data-bs-* attributes
  const urlString = button.getAttribute('data-bs-url-string')
  const name = button.getAttribute('data-bs-name')
  const lastName = button.getAttribute('data-bs-lastName').toLowerCase()
  const entryType = button.getAttribute('data-bs-entry-type')

  // Find prev and next button
  const buttonIndex = previewTriggerButtons.indexOf(button)
  const [prevButton, nextButton] = [previewTriggerButtons[buttonIndex-1], previewTriggerButtons[buttonIndex+1]]
  {{/* console.debug(previewTriggerButtons, button, buttonIndex)
  console.debug(previewTriggerButtons[buttonIndex-1], previewTriggerButtons[buttonIndex+1]) */}}

  const modalPreviewVideo = previewModal.querySelector('#ModalPreviewVideo')
  const modalPrevButton = document.querySelector('#ModalButtonPrev')
  const modalNextButton = document.querySelector('#ModalButtonNext')
  
  modalPrevButton.onclick = (e) => {
    console.debug("prev")
    prevButton && prevButton.click();
    modalPrevButton.setAttribute("data-active", "true")
    setTimeout(()=> {
        modalPrevButton.setAttribute("data-active", "false")
    }, 250)
    e.preventDefault();
  }
  modalNextButton.onclick = (e) => {
    console.debug("next")
    nextButton && nextButton.click();
    modalNextButton.setAttribute("data-active", "true")
    setTimeout(()=> {
        modalNextButton.setAttribute("data-active", "false")
    }, 250)
    e.preventDefault();
  }

  // If necessary, you could initiate an AJAX request here
  // and then do the updating in a callback.
  //
  // Update the modal's content.

  const modalTitle = previewModal.querySelector('.modal-title')
  modalTitle.textContent = name

  
  switch(entryType) {
    case 'image':
      const modalPreviewImage = previewModal.querySelector('#ModalPreviewImage')
      modalPreviewImage.src = urlString
      previewModal.querySelector(".image-container").classList.remove('hidden')
      break;
    case 'video':
      const videoHashForThumbnail = '#t=0.1';
      {{/* let videoSourceType = 'video/'
      switch (lastName) {
          case 'mov':
            videoSourceType += 'mp4'
            break;
          default:
            videoSourceType += lastName
      } */}}

      
      {{/* const maxHeight = */}}

      modalPreviewVideo.querySelector('source').setAttribute('src', urlString + videoHashForThumbnail)
      {{/* modalPreviewVideo.querySelector('source').setAttribute('type', videoSourceType) */}}
      previewModal.querySelector(".video-container").classList.remove('hidden')
      modalPreviewVideo.load()

      break;
    default:
      break;
  }

 
})
</script>
{{ end }}